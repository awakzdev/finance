<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investment Strategy Comparison</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <!-- Include Papa Parse for CSV parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            display: flex;
            flex-direction: column;
            direction: ltr;
            text-align: left;
        }

        .dropdown {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            width: 100%;
            padding: 12px 15px;
            font-size: 16px;
            line-height: 1.6;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #f9f9f9;
            cursor: pointer;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .header {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            margin-bottom: 20px;
            text-align: left;
        }

        button {
            margin-left: auto;
            padding: 10px 20px;
            font-size: 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .main-content {
            display: flex;
            justify-content: space-between;
            flex-direction: row;
            text-align: left;
        }

        .left-section {
            flex: 1;
            max-width: 300px;
            text-align: left;
        }

        .right-section {
            flex: 2;
            padding-left: 20px;
            text-align: left;
        }

        .input-group {
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            text-align: left;
        }

        .input-group label {
            margin-bottom: 5px;
            font-weight: bold;
        }

        .slider {
            width: 100%;
            margin-top: 5px;
            direction: ltr;
        }

        .results {
            margin-top: 30px;
            padding: 20px;
            background-color: #f4f4f4;
            border-radius: 5px;
            text-align: left;
        }

        #portfolioChart {
            width: 100%;
            height: 600px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Investment Strategy Comparison</h1>
        <button id="downloadCSV" onclick="downloadCSV()">Download CSV</button>
    </div>

    <div class="main-content">
        <div class="left-section">
            <div class="input-group">
                <label for="dateRange">Select Opening Range:</label>
                <select id="dateRange" class="dropdown"></select>
            </div>            

            <div class="input-group">
                <label for="closingDate">Select Closing Date:</label>
                <select id="closingDate" class="dropdown"></select>
            </div>

            <div class="input-group">
                <label for="totalInvestment">Total Investment ($): <span id="totalInvestmentValue">100000</span></label>
                <input type="range" id="totalInvestment" class="slider" min="50000" max="200000" value="100000" step="1000">
            </div>
            <div class="input-group">
                <label for="split">Investment vs. Cash Split (%): <span id="splitValue">50%</span></label>
                <input type="range" id="split" class="slider" min="0" max="100" value="50" step="1">
            </div>
            <div class="input-group">
                <label for="buyThreshold">Buy Threshold (% drop): <span id="buyThresholdValue">5%</span></label>
                <input type="range" id="buyThreshold" class="slider" min="1" max="20" value="5" step="1">
            </div>
            <div class="input-group">
                <label for="sellThreshold">Sell Threshold (% increase): <span id="sellThresholdValue">10%</span></label>
                <input type="range" id="sellThreshold" class="slider" min="1" max="30" value="10" step="1">
            </div>
            <div class="input-group">
                <label for="buyAmountPercent">Buy Percentage from Cash (%): <span id="buyAmountPercentValue">10%</span></label>
                <input type="range" id="buyAmountPercent" class="slider" min="1" max="50" value="10" step="1">
            </div>

            <div class="results">
                <h2>Results</h2>
                <p><strong>Total Investment:</strong> $<span id="totalValueDisplay">100000</span></p>
                <p><strong>Buy Amount on Each Purchase:</strong> $<span id="buyAmountDisplay">Calculating...</span></p>
                <p><strong>Available Money for Active Investment:</strong> $<span id="availableMoneyDisplay">Calculating...</span></p>
                <p><strong>Stocks Left:</strong> <span id="stocksLeft">Calculating...</span> <span id="stocksValue">($Calculating...)</span></p>
                <p><strong>Final Portfolio Value (Active + Passive):</strong> $<span id="finalTotalValue">Calculating...</span></p>
            </div>
        </div>

        <div class="right-section">
            <div id="portfolioChart"></div>
        </div>
    </div>

    <script>
        let stockData = [];
        let buyPoints = [];
        let sellPoints = [];
        let ndxStockData = [];
        let activePortfolioValues = [];
        let totalPortfolioValues = [];
        let ndxPortfolioValues = [];
        let datasetsLoaded = 0;

        const totalInvestmentSlider = document.getElementById('totalInvestment');
        const splitSlider = document.getElementById('split');
        const buyThresholdSlider = document.getElementById('buyThreshold');
        const sellThresholdSlider = document.getElementById('sellThreshold');
        const buyAmountPercentSlider = document.getElementById('buyAmountPercent');
        const dateRangeDropdown = document.getElementById('dateRange');

        const totalInvestmentValue = document.getElementById('totalInvestmentValue');
        const splitValue = document.getElementById('splitValue');
        const buyThresholdValue = document.getElementById('buyThresholdValue');
        const sellThresholdValue = document.getElementById('sellThresholdValue');
        const buyAmountPercentValue = document.getElementById('buyAmountPercentValue');
        const totalValueDisplay = document.getElementById('totalValueDisplay');
        const buyAmountDisplay = document.getElementById('buyAmountDisplay');
        const finalTotalValueDisplay = document.getElementById('finalTotalValue');
        const stocksLeftDisplay = document.getElementById('stocksLeft');
        const stocksValueDisplay = document.getElementById('stocksValue');
        const availableMoneyDisplay = document.getElementById('availableMoneyDisplay');

        window.onload = function() {
            fetchData();
            setupEventListeners();
        };

        function fetchData() {
            fetchCSV('https://raw.githubusercontent.com/awakzdev/finance/main/qld_stock_data.csv', 'QLD');
            fetchCSV('https://raw.githubusercontent.com/awakzdev/finance/main/^ndx_stock_data.csv', 'NDX');
        }

        function fetchCSV(url, type) {
            fetch(url)
                .then(response => response.text())
                .then(csvText => parseCSVData(csvText, type))
                .catch(error => console.error(`Error fetching ${type} CSV file:`, error));
        }

        function parseCSVData(csvText, type) {
            Papa.parse(csvText, {
                header: true,
                dynamicTyping: true,
                complete: function(results) {
                    const parsedData = results.data.filter(row => row.Date && row.Close && row.Open)
                        .map(row => ({
                            date: row.Date.trim(),
                            price: row.Close,
                            openPrice: row.Open,
                            dateObj: new Date(row.Date.trim().split('/').reverse().join('-'))
                        }));

                    if (type === 'QLD') {
                        stockData = parsedData;
                    } else if (type === 'NDX') {
                        ndxStockData = parsedData;
                    }

                    datasetsLoaded++;
                    if (datasetsLoaded === 2) {
                        populateDateDropdown();
                        calculateResults();
                    }
                }
            });
        }

        function populateDateDropdown() {
            const combinedDates = [...stockData, ...ndxStockData].map(data => data.dateObj.getTime());
            const uniqueDates = [...new Set(combinedDates)].sort((a, b) => a - b).map(time => new Date(time));

            dateRangeDropdown.innerHTML = '';
            const closingDateDropdown = document.getElementById('closingDate');
            closingDateDropdown.innerHTML = '';

            uniqueDates.forEach(date => {
                const dateStr = formatDate(date);
                const option1 = document.createElement('option');
                option1.value = dateStr;
                option1.textContent = dateStr;
                dateRangeDropdown.appendChild(option1);

                const option2 = document.createElement('option');
                option2.value = dateStr;
                option2.textContent = dateStr;
                closingDateDropdown.appendChild(option2);
            });

            dateRangeDropdown.value = formatDate(uniqueDates[0]);
            closingDateDropdown.value = formatDate(uniqueDates[uniqueDates.length - 1]);
        }

        function calculateResults() {
            const selectedStartDate = parseDate(document.getElementById('dateRange').value);
            const selectedClosingDate = parseDate(document.getElementById('closingDate').value);

            const filteredStockData = stockData.filter(data => data.dateObj >= selectedStartDate && data.dateObj <= selectedClosingDate);
            const filteredNDXStockData = ndxStockData.filter(data => data.dateObj >= selectedStartDate && data.dateObj <= selectedClosingDate);

            if (!filteredStockData.length || !filteredNDXStockData.length) {
                finalTotalValueDisplay.textContent = 'No data';
                updatePlotly([], [], [], []);
                return;
            }

            let totalPortfolioValue = parseInt(totalInvestmentSlider.value);
            let cashPercent = parseInt(splitSlider.value) / 100;
            let buyAmountPercent = parseFloat(buyAmountPercentSlider.value) / 100;
            let buyThreshold = parseFloat(buyThresholdSlider.value) / 100;
            let sellThreshold = parseFloat(sellThresholdSlider.value) / 100;

            let initialCash = totalPortfolioValue * cashPercent;
            let cash = initialCash;
            let initialPassiveInvestment = totalPortfolioValue * (1 - cashPercent);
            let passiveShares = initialPassiveInvestment / filteredStockData[0].openPrice;
            let passiveInvestmentPrice = filteredStockData[0].openPrice;
            let activeInvestments = [];
            let totalProfit = 0;

            activePortfolioValues = [];
            totalPortfolioValues = [];
            buyPoints = [];
            sellPoints = [];

            filteredStockData.forEach((data, index) => {
                const price = data.price;
                const date = data.dateObj;

                if (index !== 0) {
                    let currentPeak = Math.max(...filteredStockData.map(d => d.price));
                    const dropFromPeak = ((currentPeak - price) / currentPeak) * 100;

                    if (dropFromPeak >= buyThreshold * 100) {
                        let buyAmount = initialCash * buyAmountPercent;
                        let sharesToBuy = Math.floor(buyAmount / price);
                        let amountSpent = sharesToBuy * price;

                        if (sharesToBuy > 0 && cash >= amountSpent) {
                            cash -= amountSpent;
                            activeInvestments.push({ buyPrice: price, shares: sharesToBuy });
                            buyPoints.push({ date, price });
                        }
                    }

                    activeInvestments = activeInvestments.filter(investment => {
                        const gainFromBuyPrice = ((price - investment.buyPrice) / investment.buyPrice) * 100;
                        if (gainFromBuyPrice >= sellThreshold * 100) {
                            let saleProceeds = investment.shares * price;
                            totalProfit += (saleProceeds - (investment.shares * investment.buyPrice));
                            cash += saleProceeds;
                            sellPoints.push({ date, price });
                            return false;
                        }
                        return true;
                    });
                }

                const activeInvestmentValue = activeInvestments.reduce((sum, inv) => sum + inv.shares * price, 0);
                const passivePortfolioValue = passiveShares * price;
                const totalValue = cash + activeInvestmentValue + passivePortfolioValue + totalProfit;

                activePortfolioValues.push({ x: date, y: totalProfit + activeInvestmentValue });
                totalPortfolioValues.push({ x: date, y: totalValue });
            });

            const finalPortfolioValue = totalPortfolioValues[totalPortfolioValues.length - 1].y;
            buyAmountDisplay.textContent = (initialCash * buyAmountPercent).toFixed(2);
            finalTotalValueDisplay.textContent = finalPortfolioValue.toFixed(2);
            stocksLeftDisplay.textContent = activeInvestments.reduce((sum, inv) => sum + inv.shares, 0);
            stocksValueDisplay.textContent = `$${activeInvestments.reduce((sum, inv) => sum + inv.shares * filteredStockData[filteredStockData.length - 1].price, 0).toFixed(2)}`;
            availableMoneyDisplay.textContent = cash.toFixed(2);

            let ndxPassiveShares = 100000 / filteredNDXStockData[0].openPrice;
            ndxPortfolioValues = filteredNDXStockData.map(data => ({
                x: data.dateObj,
                y: ndxPassiveShares * data.price
            }));

            updatePlotly(totalPortfolioValues, activePortfolioValues, buyPoints, sellPoints, ndxPortfolioValues);
        }

        function updatePlotly(totalPortfolioValues, activePortfolioValues, buyPoints, sellPoints, ndxPortfolioValues) {
            const totalValuesTrace = {
                x: totalPortfolioValues.map(v => v.x),
                y: totalPortfolioValues.map(v => v.y),
                mode: 'lines',
                name: 'Total Portfolio Value'
            };

            const activeTrace = {
                x: activePortfolioValues.map(v => v.x),
                y: activePortfolioValues.map(v => v.y),
                mode: 'lines',
                name: 'Active Portfolio'
            };

            const buyTrace = {
                x: buyPoints.map(p => p.date),
                y: buyPoints.map(p => p.price),
                mode: 'markers',
                name: 'Buy Points',
                marker: { color: 'green', size: 8 }
            };

            const sellTrace = {
                x: sellPoints.map(p => p.date),
                y: sellPoints.map(p => p.price),
                mode: 'markers',
                name: 'Sell Points',
                marker: { color: 'red', size: 8 }
            };

            const ndxTrace = {
                x: ndxPortfolioValues.map(v => v.x),
                y: ndxPortfolioValues.map(v => v.y),
                mode: 'lines',
                name: 'NDX Passive Investment'
            };

            const layout = {
                title: 'Portfolio Performance',
                xaxis: { title: 'Date' },
                yaxis: { title: 'Value ($)' }
            };

            Plotly.newPlot('portfolioChart', [totalValuesTrace, activeTrace, buyTrace, sellTrace, ndxTrace], layout);
        }

        function setupEventListeners() {
            totalInvestmentSlider.addEventListener('input', () => {
                totalInvestmentValue.textContent = totalInvestmentSlider.value;
                calculateResults();
            });

            splitSlider.addEventListener('input', () => {
                splitValue.textContent = `${splitSlider.value}%`;
                calculateResults();
            });

            buyThresholdSlider.addEventListener('input', () => {
                buyThresholdValue.textContent = `${buyThresholdSlider.value}%`;
                calculateResults();
            });

            sellThresholdSlider.addEventListener('input', () => {
                sellThresholdValue.textContent = `${sellThresholdSlider.value}%`;
                calculateResults();
            });

            buyAmountPercentSlider.addEventListener('input', () => {
                buyAmountPercentValue.textContent = `${buyAmountPercentSlider.value}%`;
                calculateResults();
            });

            document.getElementById('closingDate').addEventListener('change', calculateResults);
            dateRangeDropdown.addEventListener('change', calculateResults);
        }

        function parseDate(dateStr) {
            const [dayStr, monthStr, yearStr] = dateStr.trim().split('/');
            return new Date(`${yearStr}-${monthStr}-${dayStr}`);
        }

        function formatDate(dateObj) {
            const day = String(dateObj.getDate()).padStart(2, '0');
            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
            const year = dateObj.getFullYear();
            return `${day}/${month}/${year}`;
        }

        function downloadCSV() {
            const csvRows = [];
            const headers = [
                'Date', 'Action', 'Shares Bought', 'Shares Sold', 'Price', 'Total Cash', 'Stocks Held', 'Passive Shares',
                'Total Shares', 'Passive Investment Price', 'Passive Profit', 'Active Profit', 'Total Value'
            ];
            csvRows.push(headers.join(','));

            window.transactionLog.forEach(log => {
                const row = [
                    log.date,
                    log.action,
                    log.sharesBought,
                    log.sharesSold,
                    log.price,
                    log.totalCash,
                    log.stocksHeld,
                    log.passiveShares,
                    log.totalShares,
                    log.passiveInvestmentPrice,
                    log.passiveProfit,
                    log.activeProfit,
                    log.totalValue
                ];
                csvRows.push(row.join(','));
            });

            const csvContent = csvRows.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('href', url);
            a.setAttribute('download', 'investment_strategy_log.csv');
            a.click();
        }
    </script>
</body>
</html>
